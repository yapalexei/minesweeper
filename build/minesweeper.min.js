/*! minesweeper 2017-07-30 */

var Sweeper=Sweeper||function(a){this.fieldSelector=a.selector||".mine-field",this.width=a.width||300,this.recursive=!!a.recursive,this.rowCount=a.rowCount||15,this.columnCount=a.columnCount||15,this.useHeatMap=!!a.useHeatMap};Sweeper.prototype.init=function(){if(this.gameEl=document.querySelector(".game"),this.fieldEl=document.querySelector(this.fieldSelector),!this.fieldEl)return void console.error("Could not find element with class",this.fieldSelector);this.fieldEl.style.width=this.width+"px",this.spaceBetween=6,this.cells=[],this.rows=[],this.mappedCells={};for(var a=0;a<this.rowCount;a++){for(var b=[],c=0;c<this.columnCount;c++){var d={id:a+"-"+c,block:document.createElement("div"),input:document.createElement("input"),label:document.createElement("label"),isMine:!1,touchingMines:0,index:this.cells.length};d.block.style.width=this.width/this.columnCount+"px",d.block.style.height=this.width/this.columnCount+"px",d.block.style.lineHeight=this.width/this.columnCount-this.spaceBetween+"px",d.block.classList.add("block"),d.label.setAttribute("for",d.id),d.input.setAttribute("id",d.id),d.input.setAttribute("type","checkbox"),d.input.setAttribute("name","block"),d.block.appendChild(d.input),d.block.appendChild(d.label),d.input.addEventListener("change",function(a){this.onChange(a)}.bind(this),!1),this.initCellState(d),this.cells.push(d),b.push(d),this.mappedCells[d.id]=d,this.fieldEl.appendChild(d.block)}this.rows.push(b)}this.setCellsIfTouchingMines(),this.resetBtn=document.createElement("button"),this.resetBtn.classList.add("reset"),this.resetBtn.appendChild(document.createTextNode("Reset")),this.resetBtn.addEventListener("click",function(){this.resetAll()}.bind(this)),this.gameEl.appendChild(this.resetBtn)},Sweeper.prototype._validateIndexs=function(a){for(var b=[],c=0;c<a.length;c++)a[c]>=0&&a[c]<this.cells.length&&b.push(a[c]);return b},Sweeper.prototype.getCellsAroundIndex=function(a){return[{row:a.row-1,col:a.col-1},{row:a.row-1,col:a.col},{row:a.row-1,col:a.col+1},{row:a.row,col:a.col-1},a,{row:a.row,col:a.col+1},{row:a.row+1,col:a.col-1},{row:a.row+1,col:a.col},{row:a.row+1,col:a.col+1}]},Sweeper.prototype.setCellsIfTouchingMines=function(){for(var a=this.rows,b=0;b<a.length;b++)for(var c=0;c<a[b].length;c++)a[b][c].isMine||this.setCellMineTouchCount({row:b,col:c})},Sweeper.prototype.setCellMineTouchCount=function(a){for(var b=this.rows[a.row][a.col],c=this.getCellsAroundIndex(a),d=0;d<c.length;d++){var e=c[d];e.row>=0&&e.row<this.rowCount&&e.col>=0&&e.col<this.columnCount&&this.rows[e.row][e.col].isMine&&b.touchingMines++}b.labelTextNode?b.labelTextNode.nodeValue=b.touchingMines:(b.labelTextNode=document.createTextNode(b.touchingMines),b.label.appendChild(b.labelTextNode)),this.useHeatMap&&b.block.classList.add("touching-"+b.touchingMines)},Sweeper.prototype.initCellState=function(a,b){a.block.className="block",a.input.classList.remove("mine"),Math.random()>.85&&(a.input.classList.add("mine"),a.isMine=!0)},Sweeper.prototype.resetAll=function(){for(var a=this.cells,b=0;b<a.length;b++)a[b].input.checked=!1,a[b].isMine=!1,a[b].touchingMines=0,a[b].labelTextNode&&(a[b].labelTextNode.nodeValue=""),this.initCellState(a[b]);this.setCellsIfTouchingMines()},Sweeper.prototype.onChange=function(a){a.preventDefault();var b=a.target;if(b.classList.contains("mine"))this.lost();else{var c=b.id.split("-"),d={row:~~c[0],col:~~c[1]};this._checkBleed(d)}},Sweeper.prototype._checkBleed=function(a){for(var b=this.getCellsAroundIndex(a),c=0;c<b.length;c++){var d=b[c];if(d.row>=0&&d.row<this.rowCount&&d.col>=0&&d.col<this.columnCount){var e=this.rows[a.row][a.col],f=this.rows[d.row][d.col];e.touchingMines!==f.touchingMines||f.input.checked||(f.input.checked=!0,this.recursive&&this._checkBleed(d))}}},Sweeper.prototype.lost=function(){for(var a=this.cells,b=0;b<a.length;b++)setTimeout(function(b){a[b].input.checked=!0},~~(1e3*Math.random()),b)};